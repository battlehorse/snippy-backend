{% extends "base.skel.html" %}
{% block script %}
  <script src="/js/autoHeight.js" type="text/javascript" charset="utf-8"></script>
{% endblock %}
{% block title %}{% if error %}Error!{% else %}{{ snippage.m.title|escape }}{% endif %}{% endblock %}
{% block main %}
  {% if error %}
    <h2>Error!</h2>
    <div class="clear-both"></div>
    <p class="error"> 
      There was a problem accessing this snippet:<br />
      {{ error }}
    </p>
  {% else %}
    <h2><img src="view_icon.png" class="inline">{{ snippage.m.title|escape }}</h2>
    <p class="publicprivate">
      {% if logged_in %}
        <a href="/my"><img src="goto.png" class="bottom" /> My Snippets</a><br />
      {% endif %}
      <a href="/"><img src="goto.png" class="bottom" /> Public Snippets</a>
    </p>
    <div class="clear-both"></div>  
    
    <div id="{{ snippage.key }}" class="snippet">
      <!-- Flagged? {{ snippage.m.flagged }} -->
      <!-- Abuses? {{ snippage.abuses_count }} -->      
      <div class="metaview">
        <form class="snippet-form">
          <input type="hidden" name="key" value="{{ snippage.key }}">
          <input type="hidden" name="public" value="{{ snippage.m.public }}">
          {% if not is_owner %}
            <a href="#" class="abuse">Report abuse</a>
          {% endif %}
          {% if is_owner %}
            <span class="public" {% if not snippage.m.public %}style="display:none"{% endif %} title="Public snippet. Click to make private.">
              Public
              <img src="snippet_public.png" class="bottom" alt="Public snippet. Click to make private.">
            </span>
            <span class="private" {% if snippage.m.public %}style="display:none"{% endif %} title="Private snippet. Click to make public.">
              Private
              <img src="snippet_private.png" class="bottom" alt="Private snippet. Click to make public.">
            </span>
            <span class="delete" title="Delete this snippet">
              Delete
              <img src="snippet_delete.png" class="bottom" alt="Delete this snippet">
            </span>
          {% endif %}
        </form>
        
        <span>
          <img src="snippet_views.png" class="bottom" title="Views" alt="Views" >
          <span class="views">{{ snippage.views_including_this }}</span> views
        </span>
        <span>
          <img src="snippet_owner.png" class="bottom" title="Author" alt="Author">
          {{ snippage.m.owner.nickname }}
        </span>
        <span>
          <img src="snippet_created.png" class="bottom" title="Creation Date" alt="Creation Date">
          {{ snippage.m.created|naturalTimeDifference }}
        </span>
        <span>
          <img src="snippet_num.png" class="bottom" title="Number of snippets" alt="Number of snippets">
          {{ snippage.snippets_count }} fragments 
        </span>
        {% if is_owner and snippage.abuses_count %}
          <span>
            <img src="snippet_abuses.png" class="bottom" title="Number of abuse reports" alt="Number of abuse reports">
            {{ snippage.abuses_count }} abuse reports
          </span>
        {% endif %}
        {% if snippage.unique_snippet_urls %}
          <div class="origin">
            Snippets originally from:
            {% for uurl in snippage.unique_snippet_urls %}
              <br /><a href="{{ uurl|escape }}">{{ uurl|escape }}</a>
            {% endfor %}
          </div>
        {% endif %}
      </div>
      <div class="clear-both"></div>
    </div>
    <iframe id="snippet-iframe" src="/inc?key={{ snippage.key }}" 
      width="100%" style="border: 0" frameborder="0" scrolling="no" class="autoHeight">
    </iframe>
    {% if is_owner and snippage.abuses_count %}
      <h3>Abuse Reports</h3>
      <ul>
      {% for abuse in snippage.m.abuses %}
        <li>
          <div class="snippet">
          {{ abuse.message|escape }}
            <div class="meta">
              <span>
                {{ abuse.reporter.nickname }}
                <img src="snippet_owner.png" class="bottom" title="Reporter" alt="Reporter">
              </span><br />
              <span>
                {{ abuse.created|naturalTimeDifference }}
                <img src="snippet_created.png" class="bottom" title="Creation Date" alt="Creation Date">
              </span><br />
            </div>
            <div class="clear-both"></div>
          </div>
        </li>
      {% endfor %}
      </ul>
    {% endif %}    
    
    {% if logged_in %}
      <input type="hidden" id="xsrf_token" value="{{ xsrf_token }}">
    {% endif %}
    
    {% if is_owner %}
      <script>
      $(document).ready(function() {
        $(".public, .private").click(function() {
          var form = $(this).closest(".snippet-form");
          var key = $("input[name='key']", form).val();
          var pub = $("input[name='public']", form).val() == 'True';
          var data = {
            'key': key,
            'public': !pub,
            'xsrf_token': $('#xsrf_token').val()
          };
          $.post('/api/togglepublic', {'payload': $.toJSON(data)}, function(data, textStatus) {
            if (data.status == 'ok') {
              if (pub) {
                // Was public, turned private
                $('#' + key).find('.public').fadeOut("fast", function() {
                  $('#' + key).find('.private').fadeIn("fast");
                });
              } else  {
                // Was privte, turned public
                $('#' + key).find('.private').fadeOut("fast", function() {
                  $('#' + key).find('.public').fadeIn("fast");
                });
              }
              $('#' + key).find("input[name='public']").val(pub ? "False" : "True")
            }
          }, 'json');
          return false;
        });
        $(".delete").click(function() {
          var form = $(this).closest(".snippet-form");
          var key = $("input[name='key']", form).val();
          var data = {
            'key': key,
            'xsrf_token': $('#xsrf_token').val()
          }
          if (confirm('Do you want to delete this item?')) {
            $.post('/api/delete', {'payload': $.toJSON(data)}, function(data, textStatus) {
              if (data.status == 'ok') {
                document.location.href = "/my"
              }
            }, 'json');
          }
          return false;
        });
      });
      </script>
    {% endif %}
    <script>
      $(document).ready(function () {
      {% if logged_in %}
        $(".abuse").click(function () {
          var link = this;
          var form = $(this).closest(".snippet-form");
          var key = $("input[name='key']", form).val();
          var textarea = $("<textarea rows='10' cols='50'></textarea>");
          var container = $("<div></div>");
          $("<p>Please give us some details about this abuse report.</p>").appendTo(container);
          textarea.appendTo(container);
          var okButton = $("<button>Submit</button>");
          var cancelButton = $("<button>Cancel</button>");
          var feedback = $("<span></span>");
          var buttonDiv = $("<div></div>");
          buttonDiv.append(cancelButton).append(okButton).append(feedback).appendTo(container);
          var boxy = new Boxy(container, {title: "Report Abuse", draggable: false, modal: true});
          cancelButton.click(function() {
            boxy.hideAndUnload();
          });
          okButton.click(function() {
            var report = textarea.val();
            if (jQuery.trim(report).length == 0) {
              feedback.text("Please write something.");
              return;
            }
            feedback.text("Submitting ...");
            var data = {
              'key': key,
              'report': report,
              'xsrf_token': $('#xsrf_token').val()
            };
            $.post('/api/reportabuse', {'payload': $.toJSON(data)}, function(data, textStatus) {
              if (data.status == 'ok') {
                feedback.text('Thanks.');
                boxy.hideAndUnload();
              } else {
                feedback.text(data.status);
              }
            }, 'json');
          });
          boxy.show();
          textarea.focus();
          return false;
        });
      {% else %}
        $(".abuse").click(function() {
          var container = $("<div></div>");
          $("<p>You must be logged in to submit abuse reports.</p>").appendTo(container);
          var okButton = $("<button>Ok</button>").appendTo(container);
          var boxy = new Boxy(container, {title: "Report Abuse", draggable: false, modal: true});
          okButton.click(function() {
            boxy.hideAndUnload();
          });
          return false;
        });
      {% endif %}        
      });
    </script>
  {% endif %}
{% endblock %}