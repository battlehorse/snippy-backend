{% extends "base.skel.html" %}
{% block script %}
  <script src="/js/autoHeight.js" type="text/javascript" charset="utf-8"></script>
{% endblock %}
{% block title %}Bits of knowledge{% endblock %}
{% block main %}
  {% if error %}
    <h2>Error!</h2>
    <div class="clear-both"></div>
    <p class="error"> 
      There was a problem accessing this snippet:<br />
      {{ error }}
    </p>
  {% else %}
    <h2><img src="view_icon.png" class="inline">{{ snippage.m.title|escape }}</h2>
    <p class="publicprivate">
      {% if logged_in %}
        <a href="/my"><img src="goto.png" class="bottom" /> My Snippets</a><br />
      {% endif %}
      <a href="/"><img src="goto.png" class="bottom" /> Public Snippets</a>
    </p>
    <div class="clear-both"></div>  
    
    <div id="{{ snippage.key }}" class="snippet">
      <!-- Flagged? {{ snippage.m.flagged }} -->
      <!-- Abuses? {{ snippage.abuses_count }} -->      
      <div class="metaview">
        <span>
          <img src="snippet_views.png" class="bottom" title="Views" alt="Views" >
          <span class="views">{{ snippage.views_including_this }}</span> views
        </span>
        <span>
          <img src="snippet_owner.png" class="bottom" title="Author" alt="Author">
          {{ snippage.m.owner.nickname }}
        </span>
        <span>
          <img src="snippet_created.png" class="bottom" title="Creation Date" alt="Creation Date">
          {{ snippage.m.created|naturalTimeDifference }}
        </span>
        <span>
          <img src="snippet_num.png" class="bottom" title="Number of snippets" alt="Number of snippets">
          {{ snippage.snippets_count }} fragments 
        </span>
        {% if is_owner %}
          <form class="snippet-form">
              <span class="public" {% if not snippage.m.public %}style="display:none"{% endif %} title="Public snippet. Click to make private.">
                Public
                <img src="snippet_public.png" class="bottom" alt="Public snippet. Click to make private.">
              </span>
              <span class="private" {% if snippage.m.public %}style="display:none"{% endif %} title="Private snippet. Click to make public.">
                Private
                <img src="snippet_private.png" class="bottom" alt="Private snippet. Click to make public.">
              </span>
            <span class="delete" title="Delete this snippet">
              Delete
              <img src="snippet_delete.png" class="bottom" alt="Delete this snippet">
            </span>

            <input type="hidden" name="key" value="{{ snippage.key }}">
            <input type="hidden" name="public" value="{{ snippage.m.public }}">
          </form>
        {% endif %}
      </div>
      <div class="clear-both"></div>
    </div>
    <iframe id="snippet-iframe" src="/inc?key={{ snippage.key }}" 
      width="100%" style="border: 0" frameborder="0" scrolling="no" class="autoHeight">
    </iframe>
    {% if is_owner %}
      <input type="hidden" id="xsrf_token" value="{{ xsrf_token }}">
      <script>
      $(document).ready(function() {
        $(".public, .private").click(function() {
          var form = $(this).closest(".snippet-form");
          var key = $("input[name='key']", form).val();
          var pub = $("input[name='public']", form).val() == 'True';
          var data = {
            'key': key,
            'public': !pub,
            'xsrf_token': $('#xsrf_token').val()
          };
          $.post('/api/togglepublic', {'payload': $.toJSON(data)}, function(data, textStatus) {
            if (data.status == 'ok') {
              if (pub) {
                // Was public, turned private
                $('#' + key).find('.public').fadeOut("fast", function() {
                  $('#' + key).find('.private').fadeIn("fast");
                });
              } else  {
                // Was privte, turned public
                $('#' + key).find('.private').fadeOut("fast", function() {
                  $('#' + key).find('.public').fadeIn("fast");
                });
              }
              $('#' + key).find("input[name='public']").val(pub ? "False" : "True")
            }
          }, 'json');
          return false;
        });
        $(".delete").click(function() {
          var form = $(this).closest(".snippet-form");
          var key = $("input[name='key']", form).val();
          var data = {
            'key': key,
            'xsrf_token': $('#xsrf_token').val()
          }
          if (confirm('Do you want to delete this item?')) {
            $.post('/api/delete', {'payload': $.toJSON(data)}, function(data, textStatus) {
              if (data.status == 'ok') {
                document.location.href = "/my"
              }
            }, 'json');
          }
          return false;
        });
      });
      </script>
    {% endif %}    
  {% endif %}
{% endblock %}